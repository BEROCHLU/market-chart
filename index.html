<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon.png">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.11/lodash.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.2.1/echarts.min.js"></script>
    <style>
    .wrapper {
        width: 100vw;
        height: 100vh;
        margin: 10px;
        padding: 0px;
        position: relative;
    }
    #cn {
        width: 95vw;
        height: 100vh;
        position: absolute;
        left: 40px;
    }

    .market-board {
        width: 5vw;
        position: absolute;
        top: 40px;
    }

    </style>
</head>

<body>
    <input type="text" id="txt">
    <input type="button" value="clear" id="clr">
    <div class="wrapper">
        <div id="cn"></div>
        <div class="market-board">
                <select size="30" name="select-ticker">
                    <option value="SPY">SPY</option>
                    <option value="QQQ">QQQ</option>
                    <option value="DIA">DIA</option>
                    <option value="IWM">IWM</option>
                    <option value="GS">GS</option>
                    <option value="MS">MS</option>
                    <option value="JPM">JPM</option>
                    <option value="WFC">WFC</option>
                    <option value="C">C</option>
                    <option value="BAC">BAC</option>
                    <option value="BTC-USD">BTC-USD</option>
                    <option value="TNA">TNA</option>
                    <option value="UPRO">UPRO</option>
                    <option value="TQQQ">TQQQ</option>
                    <option value="TZA">TZA</option>
                    <option value="SPXU">SPXU</option>
                    <option value="SQQQ">SQQQ</option>
                    <option value="VXX">VXX</option>
                    <option value="GLD">GLD</option>
                    <option value="TLT">TLT</option>
                    <option value="USO">USO</option>
                </select>
            </div>
        <script>
        'use strict';
        $('#txt').change(function() {
            const t = $('#txt').val();
            const URL = `/?q=${t}`;
            //location.href = URL;

            fetch(URL, {
                    method: 'GET',
                    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                })
                .then(response => response.json())
                .then(json => {
                    //console.log(json);
                    const arrDate = _.map(json.Open, (value, key) => {
                        const n = parseInt(key);
                        return moment(new Date(n)).format('YYYY/MM/DD');
                    });

                    const ticker = $('#txt').val();

                    const strName = _.chain(json.shortName).values().head().value();

                    const arrLow = _.values(json.Low);
                    const arrHigh = _.values(json.High)
                    //open close low high
                    let arrPlot = _.zip(_.values(json.Open), _.values(json.Close), arrLow, arrHigh);
                    let pandaChart = echarts.init(document.getElementById('cn'));

                    let plot_min = _.min(arrLow);
                    let plot_max = _.max(arrHigh);

                    plot_min = _.floor(plot_min * 0.97);
                    plot_max = _.ceil(plot_max * 1.03);

                    let option = {
                        title: {
                            text: strName
                        },
                        xAxis: {
                            data: arrDate
                        },
                        yAxis: {
                            min: plot_min,
                            max: plot_max
                        },
                        tooltip: {
                            trigger: 'item', //item | axis | node
                            axisPointer: {
                                type: 'cross'
                            }
                        },
                        grid: {
                            left: '5%',
                            top: '5%',
                            right: '5%',
                            bottom: '5%',
                            zlevel: 10
                        },
                        series: [{
                            type: 'k',
                            data: arrPlot
                        }]
                    };

                    pandaChart.setOption(option);
                })
                .catch(e => {
                    console.log(e)
                });
        });

        $('#clr').click(function() {
            $('#txt').val(''); //clear text
        });

        $('select[name="select-ticker"]').click(function(){
            $('#txt').val(this.value);
            $('#txt').trigger('change');
            //console.log(this.value);
        });
        </script>
    </div>
</body>

</html>
